-- Expression evaluator

import List;
import State;


-- The evaluator itself: takes a state and an expression,
-- returns integer value
--
-- An expression is represented by a data structure of the following shape:
--
-- expr = Var   (string)             |
--        Const (int)                |
--        Binop (string, expr, expr)

public fun evalExpr (st, expr) {
  case expr of 
    Const(n) -> n |
    Var(n) -> st (n) |
    Binop(oper, leftExpr, rightExpr) -> 
    case oper of 
    "+" -> evalExpr (st, leftExpr) + evalExpr (st, rightExpr) |
    "-" -> evalExpr (st, leftExpr) - evalExpr (st, rightExpr) |
    "*" -> evalExpr (st, leftExpr) * evalExpr (st, rightExpr) |
    "/" -> evalExpr (st, leftExpr) / evalExpr (st, rightExpr) |
    "%" -> evalExpr (st, leftExpr) % evalExpr (st, rightExpr) |
    "<" -> evalExpr (st, leftExpr) < evalExpr (st, rightExpr) |
    ">" -> evalExpr (st, leftExpr) > evalExpr (st, rightExpr) |
    "<=" -> evalExpr (st, leftExpr) <= evalExpr (st, rightExpr) |
    ">=" -> evalExpr (st, leftExpr) >= evalExpr (st, rightExpr) |
    "==" -> evalExpr (st, leftExpr) == evalExpr (st, rightExpr) |
    "!=" -> evalExpr (st, leftExpr) != evalExpr (st, rightExpr) |
    "&&" -> evalExpr (st, leftExpr) && evalExpr (st, rightExpr) |
    "!!" -> evalExpr (st, leftExpr) !! evalExpr (st, rightExpr) |
    _ -> failure ("Bad binop\n")
    esac |
    _ -> failure ("Bad expr")
  esac
}
